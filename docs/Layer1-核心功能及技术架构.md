# 武林小镇 (wulin-town) - 核心功能及技术架构

> 文档级别：Layer 1
> 版本：1.0
> 日期：2026-01-07
> 状态：已审核通过

---

## 项目愿景

**用 AI 技术，让《武林外传》的角色在 AI 时代永生，继续同福客栈的故事。**

面向《武林外传》电视剧同好群体的二创作品。

---

## 一、三大核心功能

| 功能 | 说明 | 技术实现 |
|------|------|----------|
| **文本生成** | 角色对话、故事续写 | LLM API (硅基流动) |
| **记忆系统** | 角色记住互动历史 | Jina Embedding + Convex 向量存储 |
| **多Agent协作** | 角色之间的自主互动 | Convex 游戏引擎 + 状态机 |

---

## 二、技术架构概览

### 前端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| React | 18.2.0 | UI 框架 |
| TypeScript | 5.1.3 | 类型安全 |
| Vite | 4.4.9 | 构建工具 |
| PixiJS | 7.2.4 | 游戏渲染 |
| pixi-viewport | 5.0.1 | 视口控制（拖拽、缩放） |
| Tailwind CSS | 3.3.3 | 样式系统 |

### 后端技术栈

| 技术 | 版本 | 用途 |
|------|------|------|
| Convex | 1.19.2 | 实时数据库 + Serverless Functions（免费层级） |

### AI 服务

| 服务 | 提供商 | 模型 | 用途 |
|------|--------|------|------|
| 对话生成 | 硅基流动 (SiliconFlow) | DeepSeek-V3 或 Qwen（待确认） | 角色对话、故事续写 |
| 文本嵌入 | Jina AI | jina-embeddings-v3 | 角色记忆向量化 |

---

## 三、系统架构图

```
┌─────────────────────────────────────────────────────────────────┐
│                         前端 (React + PixiJS)                    │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   游戏画布    │  │   玩家面板    │  │      对话输入         │  │
│  │  (PixiGame)  │  │(PlayerDetails)│  │   (MessageInput)     │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                      Convex 后端服务                             │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   世界状态    │  │   游戏引擎    │  │      Agent 系统       │  │
│  │   (world)    │  │   (engine)   │  │     (aiTown/agent)   │  │
│  └──────────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────────┐
│                        外部 AI 服务                              │
│  ┌──────────────────────┐  ┌─────────────────────────────────┐  │
│  │   硅基流动 LLM API    │  │        Jina Embedding API       │  │
│  │  (对话生成)          │  │       (记忆向量化)               │  │
│  └──────────────────────┘  └─────────────────────────────────┘  │
└─────────────────────────────────────────────────────────────────┘
```

---

## 四、数据流

### 用户与角色对话

```
用户输入 → MessageInput → Convex mutation
         → Agent 系统 → 硅基流动 LLM
         → 生成回复 → 更新世界状态
         → 实时同步到前端
```

### 角色记忆系统

```
对话内容 → Jina Embedding → 向量化
         → Convex 存储 → 记忆检索
         → 注入 Prompt → 生成有记忆的回复
```

### 多Agent协作

```
游戏引擎定时触发 → 检查各角色状态
                → 决策下一动作（移动/对话/活动）
                → 更新世界状态
                → 前端渲染
```

---

## 五、核心配置

| 配置项 | 值 |
|--------|-----|
| 部署路径 | `/wulin-town` |
| 用户认证 | 随机访客 ID（localStorage 持久化） |
| Fly.io 域名占位符 | `wulin-town.fly.dev` |

---

## 六、API 配置（待确认）

### 硅基流动 (SiliconFlow)

```
API URL: [待用户提供]
API Key: [待用户提供]
模型: DeepSeek-V3 或 Qwen [待确认]
```

### Jina AI

```
API Key: [待用户提供]
模型: jina-embeddings-v3
```

---

## 七、角色配置（当前）

| 角色 | 精灵图 | 简介 |
|------|--------|------|
| 佟湘玉 | f1 | 同福客栈掌柜，精明能干的陕西女人 |
| 白展堂 | f2 | 跑堂，江湖人称"盗圣"，已金盆洗手 |
| 郭芙蓉 | f3 | 杂役，郭巨侠之女，性格泼辣 |
| 吕秀才 | f4 | 账房先生，饱读诗书但屡试不中 |
| 李大嘴 | f5 | 厨子，原御膳房厨师 |
| 莫小贝 | f6 | 佟湘玉小姑子，衡山派掌门 |
| 邢捕头 | f7 | 七侠镇捕头，为人正直 |
| 祝无双 | f8 | 温柔善良，武功高强 |
| 燕小六 | f1 | 捕快，邢捕头手下 |

---

*文档已审核通过 - 2026-01-07*
