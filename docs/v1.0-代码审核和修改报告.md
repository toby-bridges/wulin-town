# 武林小镇 (wulin-town) v1.0 代码审核和修改报告

> 文档版本：1.0
> 日期：2026-01-07
> 基于项目：a16z-infra/ai-town

---

## 项目愿景

**用 AI 技术，让《武林外传》的角色在 AI 时代永生，继续同福客栈的故事。**

面向《武林外传》电视剧同好群体的二创作品。

---

## 一、代码审查修复记录

### High 级别

| 问题 | 修复方案 | 涉及文件 |
|------|---------|---------|
| 资源路径混用导致 404 | 统一为 `/wulin-town` | `vite.config.ts`, `data/characters.ts`, `data/gentle.js`, `convex/music.ts`, `src/index.css`, `src/components/PixiStaticMap.tsx`, `vercel.json`, `index.html` |
| 所有访客共享同一身份 | 实现随机访客 ID 系统 | `convex/world.ts`, `src/hooks/useVisitorId.ts`(新建), `InteractButton.tsx`, `PixiGame.tsx` |
| 依赖未就绪时白屏 | 添加加载状态 UI | `src/components/Game.tsx` |

### Medium 级别

| 问题 | 修复方案 | 涉及文件 |
|------|---------|---------|
| IME 输入法 Enter 误触发 | 检查 `isComposing` 状态 | `src/components/MessageInput.tsx` |
| 地图点击坐标偏移 | 改用 `e.global.x/y` 替代 `screenX/Y` | `src/components/PixiGame.tsx` |

### Low 级别

| 问题 | 修复方案 | 涉及文件 |
|------|---------|---------|
| FreezeButton 资源路径错误 | 改用 import 导入 | `src/components/FreezeButton.tsx` |
| 链接缺少 noopener | 添加 `rel="noopener noreferrer"` | `src/App.tsx`, `PoweredByConvex.tsx` |
| Button 组件语义化 | 无 href 时用 `<button>` | `src/components/buttons/Button.tsx` |
| sound.add 重复注册 | 添加 `sound.exists()` 检查和清理 | `src/components/buttons/MusicButton.tsx` |
| Replicate webhook 默认值错误 | 修复运算符优先级问题 | `convex/music.ts` |

---

## 二、项目配置决策

| 配置项 | 决策 |
|--------|------|
| 部署路径 | `/wulin-town` |
| 用户认证 | 随机访客 ID（无需登录，自动区分用户） |
| 第三方元素 | 保留 Convex 角标，移除 Plausible 统计 |
| Fly.io 域名占位符 | `wulin-town.fly.dev` |

---

## 三、命名规范

- **保留原样**：原始项目的外部链接（GitHub、Convex）、README 等文档中的引用
- **改为 wulin-town**：项目内部的路径、网络名称、包名等

---

## 四、资源工作流程

1. 技术修复 ✅ 已完成
2. 用户逐项审核确认资源（音乐、文本、图片）
3. 确认后同步到项目

---

## 五、新增文件

### `src/hooks/useVisitorId.ts`

访客 ID 生成与持久化系统，功能：
- 生成唯一访客 ID（格式：`visitor_时间戳_随机串`）
- 存储到 localStorage 持久化
- 提供 `useVisitorId()` hook 供组件使用
- 提供 `getVisitorDisplayName()` 生成友好显示名（如"访客A1B2"）

---

## 六、角色配置

当前配置的《武林外传》角色：

| 角色 | 精灵图 | 简介 |
|------|--------|------|
| 佟湘玉 | f1 | 同福客栈掌柜，精明能干的陕西女人 |
| 白展堂 | f2 | 跑堂，江湖人称"盗圣"，已金盆洗手 |
| 郭芙蓉 | f3 | 杂役，郭巨侠之女，性格泼辣 |
| 吕秀才 | f4 | 账房先生，饱读诗书但屡试不中 |
| 李大嘴 | f5 | 厨子，原御膳房厨师 |
| 莫小贝 | f6 | 佟湘玉小姑子，衡山派掌门 |
| 邢捕头 | f7 | 七侠镇捕头，为人正直 |
| 祝无双 | f8 | 温柔善良，武功高强 |
| 燕小六 | f1 | 捕快，邢捕头手下 |

---

## 七、待完成事项

- [ ] 更新角色定妆照/精灵图
- [ ] 更新背景音乐（武林外传主题相关）
- [ ] 界面文字本地化（按钮、提示等）
- [ ] 场景图片更新

---

*报告完成*
